name: Deploy SkillSwap API to Koyeb ðŸš€

# This workflow is triggered when the build workflow completes successfully
on:
  
  # DÃ©clenchement direct depuis le workflow de build
  repository_dispatch:
    types: [deploy-api-trigger]
  
  # DÃ©clenchement manuel pour tests
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Combined step to install Koyeb CLI and deploy in a single shell context
      # This ensures the PATH variable is properly set when running the koyeb command
      - name: Install Koyeb CLI and Deploy to Koyeb ðŸš€ðŸš€
        env:
          # Get the Koyeb API token from GitHub secrets
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}

        # Download and install the Koyeb CLI to the user's home directorykoyeb service redeploy coloured-reina/skillswap-api
        # Add the Koyeb CLI to the PATH for this shell session
        # Update the existing service on Koyeb with the latest Docker image
        # This assumes the service "skillswap-api" already exists on Koyeb
        run: |
          curl -fsSL https://raw.githubusercontent.com/koyeb/koyeb-cli/master/install.sh | sh
          
          export PATH=$HOME/.koyeb/bin:$PATH
          
          # VÃ©rification de l'installation
          echo "Version de Koyeb CLI:"
          koyeb --version
          
          # DÃ©ploiement du service
          echo "DÃ©ploiement de l'API sur Koyeb..."
          koyeb service redeploy coloured-reina/skillswap-api
